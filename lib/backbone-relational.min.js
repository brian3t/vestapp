var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(f,c,e){f instanceof String&&(f=String(f));for(var l=f.length,n=0;n<l;n++){var q=f[n];if(c.call(e,q,n,f))return{i:n,v:q}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,c,e){f!=Array.prototype&&f!=Object.prototype&&(f[c]=e.value)};
$jscomp.getGlobal=function(f){return"undefined"!=typeof window&&window===f?f:"undefined"!=typeof global&&null!=global?global:f};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(f,c,e,l){if(c){e=$jscomp.global;f=f.split(".");for(l=0;l<f.length-1;l++){var n=f[l];n in e||(e[n]={});e=e[n]}f=f[f.length-1];l=e[f];c=c(l);c!=l&&null!=c&&$jscomp.defineProperty(e,f,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(f){return f?f:function(c,e){return $jscomp.findInternal(this,c,e).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(f){return $jscomp.SYMBOL_PREFIX+(f||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.iterator;f||(f=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[f]&&$jscomp.defineProperty(Array.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(f){var c=0;return $jscomp.iteratorPrototype(function(){return c<f.length?{done:!1,value:f[c++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(f){$jscomp.initSymbolIterator();f={next:f};f[$jscomp.global.Symbol.iterator]=function(){return this};return f};$jscomp.iteratorFromArray=function(f,c){$jscomp.initSymbolIterator();f instanceof String&&(f+="");var e=0,l={next:function(){if(e<f.length){var n=e++;return{value:c(n,f[n]),done:!1}}l.next=function(){return{done:!0,value:void 0}};return l.next()}};l[Symbol.iterator]=function(){return l};return l};
$jscomp.polyfill("Array.prototype.keys",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");$jscomp.polyfill("Array.prototype.values",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(c,e){return e})}},"es6","es3");
(function(f,c){"function"===typeof define&&define.amd?define(["exports","backbone","underscore"],c):"undefined"!==typeof exports?c(exports,require("backbone"),require("underscore")):c(f,f.Backbone,f._)})(this,function(f,c,e){c.Relational={showWarnings:!0};c.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw Error("All permits released");
this._permitsUsed--},isLocked:function(){return 0<this._permitsUsed},setAvailablePermits:function(a){if(this._permitsUsed>a)throw Error("Available permits cannot be less than used permits");this._permitsAvailable=a}};c.BlockingQueue=function(){this._queue=[]};e.extend(c.BlockingQueue.prototype,c.Semaphore,{_queue:null,add:function(a){this.isBlocked()?this._queue.push(a):a()},process:function(){var a=this._queue;for(this._queue=[];a&&a.length;)a.shift()()},block:function(){this.acquire()},unblock:function(){this.release();
this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}});c.Relational.eventQueue=new c.BlockingQueue;c.Store=function(){this._collections=[];this._reverseRelations=[];this._orphanRelations=[];this._subModels=[];this._modelScopes=[f]};e.extend(c.Store.prototype,c.Events,{initializeRelation:function(a,b,d){var h=e.isString(b.type)?c[b.type]||this.getObjectByName(b.type):b.type;h&&h.prototype instanceof c.Relation?new h(a,b,d):c.Relational.showWarnings&&"undefined"!==typeof console&&
console.warn("Relation=%o; missing or invalid relation type!",b)},addModelScope:function(a){this._modelScopes.push(a)},removeModelScope:function(a){this._modelScopes=e.without(this._modelScopes,a)},addSubModels:function(a,b){this._subModels.push({superModelType:b,subModels:a})},setupSuperModel:function(a){e.find(this._subModels,function(b){return e.filter(b.subModels||[],function(d,c){d=this.getObjectByName(d);if(a===d)return b.superModelType._subModels[c]=a,a._superModel=b.superModelType,a._subModelTypeValue=
c,a._subModelTypeAttribute=b.superModelType.prototype.subModelTypeAttribute,!0},this).length},this)},addReverseRelation:function(a){!e.any(this._reverseRelations,function(b){return e.all(a||[],function(a,c){return a===b[c]})})&&a.model&&a.type&&(this._reverseRelations.push(a),this._addRelation(a.model,a),this.retroFitRelation(a))},addOrphanRelation:function(a){!e.any(this._orphanRelations,function(b){return e.all(a||[],function(a,c){return a===b[c]})})&&a.model&&a.type&&this._orphanRelations.push(a)},
processOrphanRelations:function(){e.each(this._orphanRelations.slice(0),function(a){c.Relational.store.getObjectByName(a.relatedModel)&&(this.initializeRelation(null,a),this._orphanRelations=e.without(this._orphanRelations,a))},this)},_addRelation:function(a,b){a.prototype.relations||(a.prototype.relations=[]);a.prototype.relations.push(b);e.each(a._subModels||[],function(a){this._addRelation(a,b)},this)},retroFitRelation:function(a){var b=this.getCollection(a.model,!1);b&&b.each(function(b){b instanceof
a.model&&new a.type(b,a)},this)},getCollection:function(a,b){a instanceof c.RelationalModel&&(a=a.constructor);for(var d=a;d._superModel;)d=d._superModel;(a=e.find(this._collections,function(a){return a.model===d}))||!1===b||(a=this._createCollection(d));return a},getObjectByName:function(a){var b=a.split("."),d=null;e.find(this._modelScopes,function(a){if((d=e.reduce(b||[],function(a,b){return a?a[b]:void 0},a))&&d!==a)return!0},this);return d},_createCollection:function(a){a instanceof c.RelationalModel&&
(a=a.constructor);if(a.prototype instanceof c.RelationalModel){var b=new c.Collection;b.model=a;this._collections.push(b)}return b},resolveIdForItem:function(a,b){var d=e.isString(b)||e.isNumber(b)?b:null;null===d&&(b instanceof c.RelationalModel?d=b.id:e.isObject(b)&&(d=b[a.prototype.idAttribute]));d||0===d||(d=null);return d},find:function(a,b){b=this.resolveIdForItem(a,b);var d=this.getCollection(a);return d&&(b=d.get(b),b instanceof a)?b:null},register:function(a){var b=this.getCollection(a);
if(b){var d=a.collection;b.add(a);a.collection=d}},checkId:function(a,b){var d=this.getCollection(a);if((b=d&&d.get(b))&&a!==b)throw c.Relational.showWarnings&&"undefined"!==typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",b,a),Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!");},update:function(a){var b=this.getCollection(a);b.contains(a)||this.register(a);b._onModelEvent("change:"+a.idAttribute,a,b);a.trigger("relational:change:id",
a,b)},unregister:function(a){if(a instanceof c.Model){var b=this.getCollection(a);var d=[a]}else a instanceof c.Collection?(b=this.getCollection(a.model),d=e.clone(a.models)):(b=this.getCollection(a),d=e.clone(b.models));e.each(d,function(a){this.stopListening(a);e.invoke(a.getRelations(),"stopListening")},this);e.contains(this._collections,a)?b.reset([]):e.each(d,function(a){b.get(a)?b.remove(a):b.trigger("relational:remove",a,b)},this)},reset:function(){this.stopListening();e.each(this._collections,
function(a){this.unregister(a)},this);this._collections=[];this._subModels=[];this._modelScopes=[f]}});c.Relational.store=new c.Store;c.Relation=function(a,b,d){this.instance=a;b=e.isObject(b)?b:{};this.reverseRelation=e.defaults(b.reverseRelation||{},this.options.reverseRelation);this.options=e.defaults(b,this.options,c.Relation.prototype.options);this.reverseRelation.type=e.isString(this.reverseRelation.type)?c[this.reverseRelation.type]||c.Relational.store.getObjectByName(this.reverseRelation.type):
this.reverseRelation.type;this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.model=this.options.model||this.instance.constructor;this.relatedModel=this.options.relatedModel;e.isUndefined(this.relatedModel)&&(this.relatedModel=this.model);!e.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof c.RelationalModel||(this.relatedModel=e.result(this,"relatedModel"));e.isString(this.relatedModel)&&
(this.relatedModel=c.Relational.store.getObjectByName(this.relatedModel));this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&c.Relational.store.addReverseRelation(e.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),a&&(a=this.keySource,a!==this.key&&e.isObject(this.instance.get(this.key))&&(a=this.key),this.setKeyContents(this.instance.get(a)),this.relatedCollection=
c.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],this.instance._relations[this.key]=this,this.initialize(d),this.options.autoFetch&&this.instance.getAsync(this.key,e.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)))};
c.Relation.extend=c.Model.extend;e.extend(c.Relation.prototype,c.Events,c.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var a=this.instance,b=this.key,d=this.model,h=this.relatedModel,f=c.Relational.showWarnings&&"undefined"!==typeof console;return d&&b&&h?d.prototype instanceof c.RelationalModel?h.prototype instanceof
c.RelationalModel?this instanceof c.HasMany&&this.reverseRelation.type===c.HasMany?(f&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1):a&&e.keys(a._relations).length&&(d=e.find(a._relations,function(a){return a.key===b},this))?(f&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,b,a,d),!1):!0:(f&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,
h),!1):(f&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,a),!1):(f&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,d,b,h),!1)},setRelated:function(a){this.related=a;this.instance.attributes[this.key]=a},_isReverseRelation:function(a){return a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key},getReverseRelations:function(a){var b=[];a=e.isUndefined(a)?this.related&&
(this.related.models||[this.related]):[a];for(var d,c,f=0;f<(a||[]).length;f++){d=a[f].getRelations()||[];for(var g=0;g<d.length;g++)c=d[g],this._isReverseRelation(c)&&b.push(c)}return b},destroy:function(){this.stopListening();this instanceof c.HasOne?this.setRelated(null):this instanceof c.HasMany&&this.setRelated(this._prepareCollection());e.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance)},this)}});c.HasOne=c.Relation.extend({options:{reverseRelation:{type:"HasMany"}},
initialize:function(a){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var b=this.findRelated(a);this.setRelated(b);e.each(this.getReverseRelations(),function(b){b.addRelated(this.instance,a)},this)},findRelated:function(a){var b=null;a=e.defaults({parse:this.options.parse},a);if(this.keyContents instanceof this.relatedModel)b=this.keyContents;else if(this.keyContents||0===this.keyContents)a=e.defaults({create:this.options.createModels},a),b=this.relatedModel.findOrCreate(this.keyContents,
a);b&&(this.keyId=null);return b},setKeyContents:function(a){this.keyContents=a;this.keyId=c.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(a,b,d){if(!this.isLocked()){this.acquire();d=d?e.clone(d):{};var h=e.isUndefined(d.__related);a=h?this.related:d.__related;h&&(this.setKeyContents(b),b=this.findRelated(d),this.setRelated(b));a&&this.related!==a&&e.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,null,d)},this);e.each(this.getReverseRelations(),
function(a){a.addRelated(this.instance,d)},this);if(!d.silent&&this.related!==a){var f=this;this.changed=!0;c.Relational.eventQueue.add(function(){f.instance.trigger("change:"+f.key,f.instance,f.related,d,!0);f.changed=!1})}this.release()}},tryAddRelated:function(a,b,d){!this.keyId&&0!==this.keyId||a.id!==this.keyId||(this.addRelated(a,d),this.keyId=null)},addRelated:function(a,b){var d=this;a.queue(function(){if(a!==d.related){var c=d.related||null;d.setRelated(a);d.onChange(d.instance,a,e.defaults({__related:c},
b))}})},removeRelated:function(a,b,d){this.related&&a===this.related&&(b=this.related||null,this.setRelated(null),this.onChange(this.instance,a,e.defaults({__related:b},d)))}});c.HasMany=c.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:c.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(a){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;!e.isFunction(this.collectionType)||
this.collectionType===c.Collection||this.collectionType.prototype instanceof c.Collection||(this.collectionType=e.result(this,"collectionType"));e.isString(this.collectionType)&&(this.collectionType=c.Relational.store.getObjectByName(this.collectionType));if(this.collectionType!==c.Collection&&!(this.collectionType.prototype instanceof c.Collection))throw Error("`collectionType` must inherit from Backbone.Collection");a=this.findRelated(a);this.setRelated(a)},_prepareCollection:function(a){this.related&&
this.stopListening(this.related);a&&a instanceof c.Collection||(a=e.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions,a=new this.collectionType(null,a));a.model=this.relatedModel;if(this.options.collectionKey){var b=!0===this.options.collectionKey?this.options.reverseRelation.key:this.options.collectionKey;a[b]&&a[b]!==this.instance?c.Relational.showWarnings&&"undefined"!==typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",
this,b,this.options.collectionKey):b&&(a[b]=this.instance)}this.listenTo(a,"relational:add",this.handleAddition).listenTo(a,"relational:remove",this.handleRemoval).listenTo(a,"relational:reset",this.handleReset);return a},findRelated:function(a){var b=null;a=e.defaults({parse:this.options.parse},a);if(this.keyContents instanceof c.Collection)this._prepareCollection(this.keyContents),b=this.keyContents;else{var d=[];e.each(this.keyContents,function(b){(b=b instanceof this.relatedModel?b:e.isObject(b)&&
a.parse&&this.relatedModel.prototype.parse?this.relatedModel.prototype.parse(e.clone(b),a):b)&&d.push(b)},this);b=this.related instanceof c.Collection?this.related:this._prepareCollection();b.set(d,e.defaults({parse:!1},a))}this.keyIds=e.difference(this.keyIds,e.pluck(b.models,"id"));return b},setKeyContents:function(a){this.keyContents=a instanceof c.Collection?a:null;this.keyIds=[];this.keyContents||!a&&0!==a||(this.keyContents=e.isArray(a)?a:[a],e.each(this.keyContents,function(a){((a=c.Relational.store.resolveIdForItem(this.relatedModel,
a))||0===a)&&this.keyIds.push(a)},this))},onChange:function(a,b,d){d=d?e.clone(d):{};this.setKeyContents(b);this.changed=!1;a=this.findRelated(d);this.setRelated(a);if(!d.silent){var h=this;c.Relational.eventQueue.add(function(){h.changed&&(h.instance.trigger("change:"+h.key,h.instance,h.related,d,!0),h.changed=!1)})}},handleAddition:function(a,b,d){d=d?e.clone(d):{};this.changed=!0;e.each(this.getReverseRelations(a),function(a){a.addRelated(this.instance,d)},this);var h=this;!d.silent&&c.Relational.eventQueue.add(function(){h.instance.trigger("add:"+
h.key,a,h.related,d)})},handleRemoval:function(a,b,d){d=d?e.clone(d):{};this.changed=!0;e.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,null,d)},this);var h=this;!d.silent&&c.Relational.eventQueue.add(function(){h.instance.trigger("remove:"+h.key,a,h.related,d)})},handleReset:function(a,b){var d=this;b=b?e.clone(b):{};!b.silent&&c.Relational.eventQueue.add(function(){d.instance.trigger("reset:"+d.key,d.related,b)})},tryAddRelated:function(a,b,d){e.contains(this.keyIds,
a.id)&&(this.addRelated(a,d),this.keyIds=e.without(this.keyIds,a.id))},addRelated:function(a,b){var d=this;a.queue(function(){d.related&&!d.related.get(a)&&d.related.add(a,e.defaults({parse:!1},b))})},removeRelated:function(a,b,d){this.related.get(a)&&this.related.remove(a,d)}});c.RelationalModel=c.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(a,b){if(b&&b.collection){var d=
this,h=this.collection=b.collection;delete b.collection;this._deferProcessing=!0;var f=function(a){a===d&&(d._deferProcessing=!1,d.processQueue(),h.off("relational:add",f))};h.on("relational:add",f);e.defer(function(){f(d)})}c.Relational.store.processOrphanRelations();c.Relational.store.listenTo(this,"relational:unregister",c.Relational.store.unregister);this._queue=new c.BlockingQueue;this._queue.block();c.Relational.eventQueue.block();try{c.Model.apply(this,arguments)}finally{c.Relational.eventQueue.unblock()}},
trigger:function(a){if(5<a.length&&0===a.indexOf("change")){var b=this,d=arguments;c.Relational.eventQueue.isBlocked()?c.Relational.eventQueue.add(function(){var e=!0;if("change"===a)e=b.hasChanged()||b._attributeChangeFired,b._attributeChangeFired=!1;else{var f=a.slice(7),g=b.getRelation(f);g?(e=!0===d[4])?b.changed[f]=d[2]:g.changed||delete b.changed[f]:e&&(b._attributeChangeFired=!0)}e&&c.Model.prototype.trigger.apply(b,d)}):c.Model.prototype.trigger.apply(b,d)}else"destroy"===a?(c.Model.prototype.trigger.apply(this,
arguments),c.Relational.store.unregister(this)):c.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(a){this.acquire();this._relations={};e.each(this.relations||[],function(b){c.Relational.store.initializeRelation(this,b,a)},this);this._isInitialized=!0;this.release();this.processQueue()},updateRelations:function(a,b){this._isInitialized&&!this.isLocked()&&e.each(this._relations,function(d){if(!a||d.keySource in a||d.key in a){var c=this.attributes[d.keySource]||
this.attributes[d.key],e=a&&(a[d.keySource]||a[d.key]);(d.related!==c||null===c&&null===e)&&this.trigger("relational:change:"+d.key,this,c,b||{})}d.keySource!==d.key&&delete this.attributes[d.keySource]},this)},queue:function(a){this._queue.add(a)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(a){return this._relations[a]},getRelations:function(){return e.values(this._relations)},getIdsToFetch:function(a,b){var d=
(a=a instanceof c.Relation?a:this.getRelation(a))?a.keyIds&&a.keyIds.slice(0)||(a.keyId||0===a.keyId?[a.keyId]:[]):[];b&&e.each(a.related&&(a.related.models||[a.related]),function(a){(a.id||0===a.id)&&d.push(a.id)});return d},getAsync:function(a,b){b=e.extend({add:!0,remove:!1,refresh:!1},b);var d=this,f=[],k=this.getRelation(a),g=k&&this.getIdsToFetch(k,b.refresh),m=k.related instanceof c.Collection?k.related:k.relatedCollection;if(g&&g.length){var l=[],n=[];f=function(){l=e.map(g,function(a){var d=
k.relatedModel.findModel(a);d||(d={},d[k.relatedModel.prototype.idAttribute]=a,d=k.relatedModel.findOrCreate(d,b),n.push(d));return d},this)};if(m instanceof c.Collection&&e.isFunction(m.url)){var q=m.url();var p=m.url(g);p===q&&(f(),p=m.url(l),p===q&&(p=null))}p?(p=e.defaults({error:function(){e.each(n,function(a){a.trigger("destroy",a,a.collection,b)});b.error&&b.error.apply(l,arguments)},url:p},b),f=[m.fetch(p)]):(l.length||f(),f=e.map(l,function(a){var d=e.defaults({error:function(){e.contains(n,
a)&&a.trigger("destroy",a,a.collection,b);b.error&&b.error.apply(l,arguments)}},b);return a.fetch(d)},this))}return this.deferArray(f).then(function(){return c.Model.prototype.get.call(d,a)})},deferArray:function(a){return c.$.when.apply(null,a)},set:function(a,b,d){c.Relational.eventQueue.block();if(e.isObject(a)||null==a){var f=a;d=b}else f={},f[a]=b;try{var k=this.id,g=f&&this.idAttribute in f&&f[this.idAttribute];c.Relational.store.checkId(this,g);var m=c.Model.prototype.set.apply(this,arguments);
this._isInitialized||this.isLocked()?g&&g!==k&&c.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),(g||0===g)&&c.Relational.store.register(this),this.initializeRelations(d));f&&this.updateRelations(f,d)}finally{c.Relational.eventQueue.unblock()}return m},clone:function(){var a=e.clone(this.attributes);e.isUndefined(a[this.idAttribute])||(a[this.idAttribute]=null);e.each(this.getRelations(),function(b){delete a[b.key]});return new this.constructor(a)},toJSON:function(a){if(this.isLocked())return this.id;
this.acquire();var b=c.Model.prototype.toJSON.call(this,a);!this.constructor._superModel||this.constructor._subModelTypeAttribute in b||(b[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue);e.each(this._relations,function(d){var f=b[d.key],k=d.options.includeInJSON,g=null;!0===k?f&&e.isFunction(f.toJSON)&&(g=f.toJSON(a)):e.isString(k)?(f instanceof c.Collection?g=f.pluck(k):f instanceof c.Model&&(g=f.get(k)),k===d.relatedModel.prototype.idAttribute&&(d instanceof c.HasMany?
g=g.concat(d.keyIds):d instanceof c.HasOne&&((g=g||d.keyId)||e.isObject(d.keyContents)||(g=d.keyContents||null)))):e.isArray(k)?f instanceof c.Collection?(g=[],f.each(function(a){var b={};e.each(k,function(d){b[d]=a.get(d)});g.push(b)})):f instanceof c.Model&&(g={},e.each(k,function(a){g[a]=f.get(a)})):delete b[d.key];null===g&&a&&a.wait&&(g=f);k&&(b[d.keyDestination]=g);d.keyDestination!==d.key&&delete b[d.key]});this.release();return b}},{setup:function(a){this.prototype.relations=(this.prototype.relations||
[]).slice(0);this._subModels={};this._superModel=null;this.prototype.hasOwnProperty("subModelTypes")?c.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null;e.each(this.prototype.relations||[],function(a){a.model||(a.model=this);if(a.reverseRelation&&a.model===this){var b=!0;e.isString(a.relatedModel)&&(b=(b=c.Relational.store.getObjectByName(a.relatedModel))&&b.prototype instanceof c.RelationalModel);b?c.Relational.store.initializeRelation(null,a):e.isString(a.relatedModel)&&
c.Relational.store.addOrphanRelation(a)}},this);return this},build:function(a,b){this.initializeModelHierarchy();return new (this._findSubModelType(this,a)||this)(a,b)},_findSubModelType:function(a,b){if(a._subModels&&a.prototype.subModelTypeAttribute in b){var d=b[a.prototype.subModelTypeAttribute],c=a._subModels[d];if(c)return c;for(d in a._subModels)if(c=this._findSubModelType(a._subModels[d],b))return c}return null},initializeModelHierarchy:function(){this.inheritRelations();if(this.prototype.subModelTypes){var a=
e.keys(this._subModels);a=e.omit(this.prototype.subModelTypes,a);e.each(a,function(a){(a=c.Relational.store.getObjectByName(a))&&a.initializeModelHierarchy()})}},inheritRelations:function(){if(e.isUndefined(this._superModel)||e.isNull(this._superModel))if(c.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.inheritRelations(),this._superModel.prototype.relations){var a=e.filter(this._superModel.prototype.relations||[],function(a){return!e.any(this.prototype.relations||[],
function(b){return a.relatedModel===b.relatedModel&&a.key===b.key},this)},this);this.prototype.relations=a.concat(this.prototype.relations)}}else this._superModel=!1},findOrCreate:function(a,b){b||(b={});var d=e.isObject(a)&&b.parse&&this.prototype.parse?this.prototype.parse(e.clone(a),b):a,c=this.findModel(d);e.isObject(a)&&(c&&!1!==b.merge?(delete b.collection,delete b.url,c.set(d,b)):c||!1===b.create||(c=this.build(d,e.defaults({parse:!1},b))));return c},find:function(a,b){b||(b={});b.create=!1;
return this.findOrCreate(a,b)},findModel:function(a){return c.Relational.store.find(this,a)}});e.extend(c.RelationalModel.prototype,c.Semaphore);c.Collection.prototype.__prepareModel=c.Collection.prototype._prepareModel;c.Collection.prototype._prepareModel=function(a,b){if(a instanceof c.Model){a.collection||(a.collection=this);var d=a}else b=b?e.clone(b):{},b.collection=this,(d="undefined"!==typeof this.model.findOrCreate?this.model.findOrCreate(a,b):new this.model(a,b))&&d.validationError&&(this.trigger("invalid",
this,a,b),d=!1);return d};var l=c.Collection.prototype.__set=c.Collection.prototype.set;c.Collection.prototype.set=function(a,b){if(!(this.model.prototype instanceof c.RelationalModel))return l.call(this,a,b);b&&b.parse&&(a=this.parse(a,b));var d=!e.isArray(a),f=[],k=[];a=d?a?[a]:[]:e.clone(a);for(var g=0;g<a.length;g++){var m=a[g];m instanceof c.Model||(m=c.Collection.prototype._prepareModel.call(this,m,b));m&&(k.push(m),this.get(m)||this.get(m.cid)?null!==m.id&&void 0!==m.id&&(this._byId[m.id]=
m):f.push(m))}k=d?k.length?k[0]:null:k;a=l.call(this,k,e.defaults({merge:!1,parse:!1},b));for(g=0;g<f.length;g++)m=f[g],(this.get(m)||this.get(m.cid))&&this.trigger("relational:add",m,this,b);return a};var n=c.Collection.prototype.___removeModels=c.Collection.prototype._removeModels;c.Collection.prototype._removeModels=function(a,b){if(!(this.model.prototype instanceof c.RelationalModel))return n.call(this,a,b);var d=[];e.each(a,function(a){(a=this.get(a)||a&&this.get(a.cid))&&d.push(a)},this);a=
n.call(this,d,b);e.each(d,function(a){this.trigger("relational:remove",a,this,b)},this);return a};var q=c.Collection.prototype.__reset=c.Collection.prototype.reset;c.Collection.prototype.reset=function(a,b){b=e.extend({merge:!0},b);a=q.call(this,a,b);this.model.prototype instanceof c.RelationalModel&&this.trigger("relational:reset",this,b);return a};var t=c.Collection.prototype.__sort=c.Collection.prototype.sort;c.Collection.prototype.sort=function(a){var b=t.call(this,a);this.model.prototype instanceof
c.RelationalModel&&this.trigger("relational:reset",this,a);return b};var r=c.Collection.prototype.__trigger=c.Collection.prototype.trigger;c.Collection.prototype.trigger=function(a){if(!(this.model.prototype instanceof c.RelationalModel))return r.apply(this,arguments);if("add"===a||"remove"===a||"reset"===a||"sort"===a){var b=this,d=arguments;e.isObject(d[3])&&(d=e.toArray(d),d[3]=e.clone(d[3]));c.Relational.eventQueue.add(function(){r.apply(b,d)})}else r.apply(this,arguments);return this};c.RelationalModel.extend=
function(a,b){a=c.Model.extend.call(this,a,b);a.setup(this);return a}});
